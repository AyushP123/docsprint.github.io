<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Xapian Administrator’s Guide &#8212; Getting Started with Xapian v1.4.1</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.4.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Getting Started with Xapian v1.4.1" href="../index.html" />
    <link rel="up" title="Advanced features" href="index.html" />
    <link rel="next" title="Scalability" href="scalability.html" />
    <link rel="prev" title="Custom Weighting Schemes" href="custom_weighting.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="scalability.html" title="Scalability"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="custom_weighting.html" title="Custom Weighting Schemes"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Getting Started with Xapian v1.4</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Advanced features</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="xapian-administrator-s-guide">
<h1><a class="toc-backref" href="#id1">Xapian Administrator&#8217;s Guide</a><a class="headerlink" href="#xapian-administrator-s-guide" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#xapian-administrator-s-guide" id="id1">Xapian Administrator&#8217;s Guide</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#databases" id="id3">Databases</a><ul>
<li><a class="reference internal" href="#glass-backend" id="id4">Glass Backend</a></li>
<li><a class="reference internal" href="#chert-backend" id="id5">Chert Backend</a></li>
<li><a class="reference internal" href="#atomic-modifications" id="id6">Atomic modifications</a></li>
<li><a class="reference internal" href="#single-writer-multiple-reader" id="id7">Single writer, multiple reader</a></li>
<li><a class="reference internal" href="#revision-numbers" id="id8">Revision numbers</a></li>
<li><a class="reference internal" href="#network-file-systems" id="id9">Network file systems</a></li>
<li><a class="reference internal" href="#which-database-format-to-use" id="id10">Which database format to use?</a></li>
<li><a class="reference internal" href="#can-i-put-other-files-in-the-database-directory" id="id11">Can I put other files in the database directory?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-strategies" id="id12">Backup Strategies</a><ul>
<li><a class="reference internal" href="#summary" id="id13">Summary</a></li>
<li><a class="reference internal" href="#detail" id="id14">Detail</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inspecting-a-database" id="id15">Inspecting a database</a></li>
<li><a class="reference internal" href="#database-maintenance" id="id16">Database maintenance</a><ul>
<li><a class="reference internal" href="#compacting-a-database" id="id17">Compacting a database</a></li>
<li><a class="reference internal" href="#merging-databases" id="id18">Merging databases</a></li>
<li><a class="reference internal" href="#checking-database-integrity" id="id19">Checking database integrity</a></li>
<li><a class="reference internal" href="#fixing-corrupted-databases" id="id20">Fixing corrupted databases</a></li>
<li><a class="reference internal" href="#converting-a-chert-database-to-a-glass-database" id="id21">Converting a chert database to a glass database</a></li>
<li><a class="reference internal" href="#converting-a-pre-1-1-4-chert-database-to-a-chert-database" id="id22">Converting a pre-1.1.4 chert database to a chert database</a></li>
<li><a class="reference internal" href="#converting-a-flint-database-to-a-chert-database" id="id23">Converting a flint database to a chert database</a></li>
<li><a class="reference internal" href="#converting-a-quartz-database-to-a-flint-database" id="id24">Converting a quartz database to a flint database</a></li>
<li><a class="reference internal" href="#converting-a-0-9-x-flint-database-to-work-with-1-0-y" id="id25">Converting a 0.9.x flint database to work with 1.0.y</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This document is intended to provide general hints, tips and advice to
administrators of Xapian systems.  It assumes that you have installed Xapian
on your system, and are familiar with the basics of creating and searching
Xapian databases.</p>
<p>The intended audience is system administrators who need to be able to perform
general management of a Xapian database, including tasks such as taking
backups and optimising performance.  It may also be useful introductory
reading for Xapian application developers.</p>
<p>The document is up-to-date for Xapian version 1.4.1.</p>
</div>
<div class="section" id="databases">
<h2><a class="toc-backref" href="#id3">Databases</a><a class="headerlink" href="#databases" title="Permalink to this headline">¶</a></h2>
<p>Xapian databases hold all the information needed to perform searches in a set
of tables.  The default database backend for the 1.4 release series is called
<cite>glass</cite>.  The default backend for the 1.2 release series was called <cite>chert</cite>,
and this is also supported by 1.4.</p>
<div class="section" id="glass-backend">
<h3><a class="toc-backref" href="#id4">Glass Backend</a><a class="headerlink" href="#glass-backend" title="Permalink to this headline">¶</a></h3>
<p>The following table always exists:</p>
<blockquote>
<div><ul class="simple">
<li>The <cite>postlist</cite> table holds a list of all the documents indexed by each term
in the database (<cite>postings</cite>), and also chunked streams of the values in each
value slot.</li>
</ul>
</div></blockquote>
<p>The following table exists by default, but you can choose not to have it:</p>
<blockquote>
<div><ul class="simple">
<li>The <cite>termlist</cite> table holds a list of all the terms which index each
document, and also the value slots used in each document.  Without this,
some features aren&#8217;t supported - see <cite>Xapian::DB_NO_TERMLIST</cite> for details.</li>
</ul>
</div></blockquote>
<p>And the following optional tables exist only when there is data to store in
them:</p>
<blockquote>
<div><ul class="simple">
<li>The <cite>docdata</cite> table holds the document data associated with each document
in the database.  If you never set any term positions, this table won&#8217;t
exist.</li>
<li>The <cite>position</cite> table holds a list of all the word positions in each document
which each term occurs at.  If you never set positional data, this table
won&#8217;t exist.</li>
<li>The <cite>spelling</cite> table holds data for suggesting spelling corrections.</li>
<li>The <cite>synonym</cite> table holds a synonym dictionary.</li>
</ul>
</div></blockquote>
<p>Each of the tables is held in a separate file with extension <cite>.glass</cite> (e.g.
<cite>postlist.glass</cite>), allowing an administrator to see how much data is being used
for each of the above purposes.</p>
<p>The <cite>.glass</cite> file actually stores the data, and is structured as a tree of
blocks, which have a default size of 8KB (though this can be set, either
through the Xapian API, or with some of the tools detailed later in this
document).</p>
<p>Changing the blocksize may have performance implications, but it is hard to
know whether these will be positive or negative for a particular combination
of hardware and software without doing some profiling.</p>
<p>The <cite>.baseA</cite> and <cite>.baseB</cite> files you may remember if you&#8217;ve worked Xapian
database backends no longer exist in glass databases - the information about
unused blocks is stored in a freelist (itself stored in unused blocks in
the <cite>.glass</cite> file, and the other information is stored in the <cite>iamglass</cite>
file.</p>
<p>Glass also supports databases stored in a single file - currently these only
support read operations, and have to be created by compacting an existing
glass database.</p>
</div>
<div class="section" id="chert-backend">
<h3><a class="toc-backref" href="#id5">Chert Backend</a><a class="headerlink" href="#chert-backend" title="Permalink to this headline">¶</a></h3>
<p>The following tables always exist:</p>
<blockquote>
<div><ul class="simple">
<li>The <cite>postlist</cite> holds a list of all the documents indexed by
each term in the database, and also chunked streams of the values in each
value slot.</li>
<li>The <cite>record</cite> holds the document data associated with each document
in the database.</li>
<li>The <cite>termlist</cite> holds a list of all the terms which index each
document, and also the value slots used in each document.</li>
</ul>
</div></blockquote>
<p>And the following optional tables exist only when there is data to store in
them:</p>
<blockquote>
<div><ul class="simple">
<li>The <cite>position</cite> holds a list of all the word positions in each
document which each term occurs at.</li>
<li>The <cite>spelling</cite> holds data for suggesting spelling corrections.</li>
<li>The <cite>synonym</cite> holds a synonym dictionary.</li>
</ul>
</div></blockquote>
<p>Each of the tables is held in a separate file, allowing an administrator to
see how much data is being used for each of the above purposes.  It is not
always necessary to fully populate these tables: for example, if phrase
searches are never going to be performed on the database, it is not necessary
to store any positionlist information.</p>
<p>If you look at a Xapian database, you will see that each of these tables
actually uses 2 or 3 files.  For example, for a &#8220;chert&#8221; format database the
termlist table is stored in the files <code class="docutils literal"><span class="pre">termlist.baseA</span></code>, <code class="docutils literal"><span class="pre">termlist.baseB</span></code>
and <code class="docutils literal"><span class="pre">termlist.DB</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">.DB</span></code> file actually stores the data, and is structured as a tree of
blocks, which have a default size of 8KB (though this can be set, either
through the Xapian API, or with some of the tools detailed later in this
document).</p>
<p>The &#8221;.baseA&#8221; and &#8221;.baseB&#8221; files are used to keep track of where to start
looking for data in the &#8221;.DB&#8221; file (the root of the tree), and which blocks are
in use.  Often only one of the &#8221;.baseA&#8221; and &#8221;.baseB&#8221; files will be present;
each of these files refers to a revision of the database, and there may be more
than one valid revision of the database stored in the &#8221;.DB&#8221; file at once.</p>
<p>Changing the blocksize may have performance implications, but it is hard to
tell whether these will be positive or negative for a particular combination
of hardware and software without doing some profiling.</p>
</div>
<div class="section" id="atomic-modifications">
<h3><a class="toc-backref" href="#id6">Atomic modifications</a><a class="headerlink" href="#atomic-modifications" title="Permalink to this headline">¶</a></h3>
<p>Xapian ensures that all modifications to its database are performed
atomically.  This means that:</p>
<blockquote>
<div><ul class="simple">
<li>From the point of view of a separate process (or a separate database object
in the same process) reading the database, all modifications made to a
database are invisible until the modifications is committed.</li>
<li>The database on disk is always in a consistent state.</li>
<li>If the system is interrupted during a modification, the database should
always be left in a valid state.  This applies even if the power is cut
unexpectedly, as long as the disk does not become corrupted due to hardware
failure.</li>
</ul>
</div></blockquote>
<p>Committing a modification requires several calls to the operating system to
make it flush any cached modifications to the database to disk.  This is to
ensure that if the system fails at any point, the database is left in a
consistent state.  Of course, this is a fairly slow process (since the system
has to wait for the disk to physically write the data), so grouping many
changes together will speed up the throughput considerably.</p>
<p>Many modifications can be explicitly grouped into a single transaction, so
that lots of changes are applied at once.  Even if an application doesn&#8217;t
explicitly protect modifications to the database using transactions, Xapian
will group modifications into transactions, applying the modifications in
batches.</p>
<p>Note that it is not currently possible to extend Xapian&#8217;s transactions to
cover multiple databases, or to link them with transactions in external
systems, such as an RDBMS.</p>
<p>Finally, note that it is possible to compile Xapian such that it doesn&#8217;t make
modifications in an atomic manner, in order to build very large databases more
quickly (search the Xapian mailing list archives for &#8220;DANGEROUS&#8221; mode for more
details).  This isn&#8217;t yet integrated into standard builds of Xapian, but may
be in future, if appropriate protections can be incorporated.</p>
</div>
<div class="section" id="single-writer-multiple-reader">
<h3><a class="toc-backref" href="#id7">Single writer, multiple reader</a><a class="headerlink" href="#single-writer-multiple-reader" title="Permalink to this headline">¶</a></h3>
<p>Xapian implements a &#8220;single writer, multiple reader&#8221; model.  This means that,
at any given instant, there is only permitted to be a single object modifying
a database, but there may (simultaneously) be many objects reading the
database at once.</p>
<p>Xapian enforces this restriction using by having a writer lock the database.
Each Xapian database directory contains a lock file named
<code class="docutils literal"><span class="pre">flintlock</span></code> (we&#8217;ve kept the same name as flint used, since the locking
technique is the same).</p>
<p>This lock-file will always exist, but will be locked using <code class="docutils literal"><span class="pre">fcntl()</span></code> when the
database is open for writing.  Because of the semantics of <code class="docutils literal"><span class="pre">fcntl()</span></code> locking,
for each WritableDatabase opened we spawn a child process to hold the lock,
which then exec-s <code class="docutils literal"><span class="pre">cat</span></code>, so you will see a <code class="docutils literal"><span class="pre">cat</span></code> subprocess of any writer
process in the output of <code class="docutils literal"><span class="pre">ps</span></code>, <code class="docutils literal"><span class="pre">top</span></code>, etc.</p>
<p>If a writer exits without being given a chance to clean up (for example, if the
application holding the writer is killed), the <code class="docutils literal"><span class="pre">fcntl()</span></code> lock will be
automatically released by the operating system.  Under Microsoft Windows, we
use a different locking technique which doesn&#8217;t require a child process, but
also means the lock is released automatically when the writing process exits.</p>
</div>
<div class="section" id="revision-numbers">
<h3><a class="toc-backref" href="#id8">Revision numbers</a><a class="headerlink" href="#revision-numbers" title="Permalink to this headline">¶</a></h3>
<p>Xapian databases contain a revision number.  This is essentially a count of
the number of modifications since the database was created, and is needed to
implement the atomic modification functionality.  It is stored as a 32 bit
integer, so there is a chance that a very frequently updated database could
cause this to overflow.  The consequence of such an overflow would be to throw
an exception reporting that the database has run out of revision numbers.</p>
<p>This isn&#8217;t likely to be a practical problem, since it would take nearly a year
for a database to reach this limit if 100 modifications were committed every
second, and no normal Xapian system will commit more than once every few
seconds.  However, if you are concerned, you can use the <code class="docutils literal"><span class="pre">xapian-compact</span></code>
tool to make a fresh copy of the database with the revision number set to 1.</p>
<p>The revision number of each table can be displayed by the <code class="docutils literal"><span class="pre">xapian-check</span></code>
tool.</p>
</div>
<div class="section" id="network-file-systems">
<h3><a class="toc-backref" href="#id9">Network file systems</a><a class="headerlink" href="#network-file-systems" title="Permalink to this headline">¶</a></h3>
<p>Xapian should work correctly over a network file system.  However, there are
various potential issues with such file systems, so we recommend
extensive testing of your particular network file system before deployment.</p>
<p>Be warned that Xapian is heavily I/O dependent, and therefore performance over
a network file system is likely to be slow unless you&#8217;ve got a very well tuned
setup.</p>
<p>Xapian needs to be able to lock a file in a database directory when
modifications are being performed.  On some network files systems (e.g., NFS)
this requires a lock daemon to be running.</p>
</div>
<div class="section" id="which-database-format-to-use">
<h3><a class="toc-backref" href="#id10">Which database format to use?</a><a class="headerlink" href="#which-database-format-to-use" title="Permalink to this headline">¶</a></h3>
<p>As of release 1.4.0, you should generally use the glass format (which is now
the default).</p>
<p>Support for the pre-1.0 quartz format (deprecated in 1.0) was removed in 1.1.0.
See below for how to convert a quartz database to a flint one.</p>
<p>The flint backend (the default for 1.0, and still supported by 1.2.x) was
removed in 1.3.0.  See below for how to convert a flint database to a chert one.</p>
<p>The chert backend (the default for 1.2) is still supported by 1.4.x, but
deprecated - only use it if you already have databases in this format; and plan
to migrate away.</p>
</div>
<div class="section" id="can-i-put-other-files-in-the-database-directory">
<h3><a class="toc-backref" href="#id11">Can I put other files in the database directory?</a><a class="headerlink" href="#can-i-put-other-files-in-the-database-directory" title="Permalink to this headline">¶</a></h3>
<p>If you wish to store meta-data or other information relating to the Xapian
database, it is reasonable to wish to put this in files inside the Xapian
database directory, for neatness.  For example, you might wish to store a list
of the prefixes you&#8217;ve applied to terms for specific fields in the database.</p>
<p>Current Xapian backends don&#8217;t do anything
which will break this technique, so as long as you don&#8217;t choose a filename
that Xapian uses itself, there should be no problems.  However, be aware that
new versions of Xapian may use new files in the database directory, and it is
also possible that new backend formats may not be compatible with the
technique.  And of course you can&#8217;t do this with a single-file glass database.</p>
</div>
</div>
<div class="section" id="backup-strategies">
<h2><a class="toc-backref" href="#id12">Backup Strategies</a><a class="headerlink" href="#backup-strategies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="summary">
<h3><a class="toc-backref" href="#id13">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>The simplest way to perform a backup is to temporarily halt modifications,
take a copy of all files in the database directory, and then allow
modifications to resume.  Read access can continue while a backup is being
taken.</li>
<li>If you have a filesystem which allows atomic snapshots to be taken of
directories (such as an LVM filesystem), an alternative strategy is to take
a snapshot and simply copy all the files in the database directory to the
backup medium.  Such a copy will always be a valid database.</li>
<li>Progressive backups are not easily possible; modifications are typically
spread throughout the database files.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="detail">
<h3><a class="toc-backref" href="#id14">Detail</a><a class="headerlink" href="#detail" title="Permalink to this headline">¶</a></h3>
<p>Even though Xapian databases are often automatically generated from source
data which is stored in a reliable manner, it is usually desirable to keep
backups of Xapian databases being run in production environments.  This is
particularly important in systems with high-availability requirements, since
re-building a Xapian database from scratch can take many hours.  It is also
important in the case where the data stored in the database cannot easily be
recovered from external sources.</p>
<p>Xapian databases are managed such that at any instant in time, there is at
least one valid revision of the database written to disk (and if there are
multiple valid revisions, Xapian will always open the most recent).
Therefore, if it is possible to take an instantaneous snapshot of all the
database files (for example, on an LVM filesystem), this snapshot is suitable
for copying to a backup medium.  Note that it is not sufficient to take a
snapshot of each database file in turn - the snapshot must be across all
database files simultaneously.  Otherwise, there is a risk that the snapshot
could contain database files from different revisions.</p>
<p>If it is not possible to take an instantaneous snapshot, the best backup
strategy is simply to ensure that no modifications are committed during the
backup procedure.  While the simplest way to implement this may be to stop
whatever processes are used to modify the database, and ensure that they close
the database, it is not actually necessary to ensure that no writers are open
on the database; it is enough to ensure that no writer makes any modification
to the database.</p>
<p>Because a Xapian database can contain more than one valid revision of the
database, it is actually possible to allow a limited number of modifications
to be performed while a backup copy is being made, but this is tricky and we
do not recommend relying on it.  Future versions of Xapian are likely to
support this better, by allowing the current revision of a database to be
preserved while modifications continue.</p>
<p>Progressive backups are not recommended for Xapian databases: Xapian database
files are block-structured, and modifications are spread throughout the
/database file.  Therefore, a progressive backup tool will not be able to take
a backup by storing only the new parts of the database.  Modifications will
normally be so extensive that most parts of the database have been modified,
however, if only a small number of modifications have been made, a binary diff
algorithm might make a usable progressive backup tool.</p>
</div>
</div>
<div class="section" id="inspecting-a-database">
<h2><a class="toc-backref" href="#id15">Inspecting a database</a><a class="headerlink" href="#inspecting-a-database" title="Permalink to this headline">¶</a></h2>
<p>When designing an indexing strategy, it is often useful to be able to check
the contents of the database.  Xapian includes a simple command-line program,
<cite>xapian-delve</cite>, to allow this (prior to 1.3.0, <cite>xapian-delve</cite> was usually
called <cite>delve</cite>, though some packages were already renaming it).</p>
<p>For example, to display the list of terms in document &#8220;1&#8221; of the database
&#8220;foo&#8221;, use:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>xapian-delve foo -r <span class="m">1</span>
</pre></div>
</div>
<p>It is also possible to perform simple searches of a database.  Xapian includes
another simple command-line program, <code class="docutils literal"><span class="pre">quest</span></code>, to support this.  <code class="docutils literal"><span class="pre">quest</span></code> is
only able to search for un-prefixed terms, the query string must be quoted to
protect it from the shell.  To search the database &#8220;foo&#8221; for the phrase &#8220;hello
world&#8221;, use:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>quest -d foo <span class="s1">&#39;&quot;hello world&quot;&#39;</span>
</pre></div>
</div>
<p>If you have installed the &#8220;Omega&#8221; CGI application built on Xapian, this can
also be used with the built-in &#8220;godmode&#8221; template to provide a web-based
interface for browsing a database.  See Omega&#8217;s documentation for more details
on this.</p>
</div>
<div class="section" id="database-maintenance">
<h2><a class="toc-backref" href="#id16">Database maintenance</a><a class="headerlink" href="#database-maintenance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="compacting-a-database">
<h3><a class="toc-backref" href="#id17">Compacting a database</a><a class="headerlink" href="#compacting-a-database" title="Permalink to this headline">¶</a></h3>
<p>Xapian databases normally have some spare space in each block to allow
new information to be efficiently slotted into the database.  However, the
smaller a database is, the faster it can be searched, so if there aren&#8217;t
expected to be many further modifications, it can be desirable to compact the
database.</p>
<p>Xapian includes a tool called <code class="docutils literal"><span class="pre">xapian-compact</span></code> for compacting databases.
This tool makes a copy of a database, and takes advantage of
the sorted nature of the source Xapian database to write the database out
without leaving spare space for future modifications.  This can result in a
large space saving.</p>
<p>The downside of compaction is that future modifications may take a little
longer, due to needing to reorganise the database to make space for them.
However, modifications are still possible, and if many modifications are made,
the database will gradually develop spare space.</p>
<p>There&#8217;s an option (<code class="docutils literal"><span class="pre">-F</span></code>) to perform a &#8220;fuller&#8221; compaction.  This option
compacts the database as much as possible, but it violates the design of the
Btree format slightly to achieve this, so it is not recommended if further
modifications are at all likely in future.  If you do need to modify a &#8220;fuller&#8221;
compacted database, we recommend you run <code class="docutils literal"><span class="pre">xapian-compact</span></code> on it without <code class="docutils literal"><span class="pre">-F</span></code>
first.</p>
<p>While taking a copy of the database, it is also possible to change the
blocksize.  If you wish to profile search speed with different blocksizes,
this is the recommended way to generate the different databases (but remember
to compact the original database as well, for a fair comparison).</p>
</div>
<div class="section" id="merging-databases">
<h3><a class="toc-backref" href="#id18">Merging databases</a><a class="headerlink" href="#merging-databases" title="Permalink to this headline">¶</a></h3>
<p>When building an index for a very large amount of data, it can be desirable to
index the data in smaller chunks (perhaps on separate machines), and then
merge the chunks together into a single database.  This can be performed using
the <code class="docutils literal"><span class="pre">xapian-compact</span></code> tool, simply by supplying several source database paths.</p>
<p>Normally, merging works by reading the source databases in parallel, and
writing the contents in sorted order to the destination database.  This will
work most efficiently if excessive disk seeking can be avoided; if you have
several disks, it may be worth placing the source databases and the
destination database on separate disks to obtain maximum speed.</p>
<p>The <code class="docutils literal"><span class="pre">xapian-compact</span></code> tool supports an additional option, <code class="docutils literal"><span class="pre">--multipass</span></code>,
which is useful when merging more than three databases.  This will cause the
postlist tables to be grouped and merged into temporary tables, which are then
grouped and merged, and so on until a single postlist table is created, which
is usually faster, but requires more disk space for the temporary files.</p>
</div>
<div class="section" id="checking-database-integrity">
<h3><a class="toc-backref" href="#id19">Checking database integrity</a><a class="headerlink" href="#checking-database-integrity" title="Permalink to this headline">¶</a></h3>
<p>Xapian includes a command-line tool to check that a database is
self-consistent.  This tool, <code class="docutils literal"><span class="pre">xapian-check</span></code>, runs through the entire database,
checking that all the internal nodes are correctly connected.  It can also be
used on a single table, for example, this command will check the termlist table
of database &#8220;foo&#8221;:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">xapian</span><span class="o">-</span><span class="n">check</span> <span class="n">foo</span><span class="o">/</span><span class="n">termlist</span><span class="p">.</span><span class="n">DB</span>
</pre></div>
</div>
</div>
<div class="section" id="fixing-corrupted-databases">
<h3><a class="toc-backref" href="#id20">Fixing corrupted databases</a><a class="headerlink" href="#fixing-corrupted-databases" title="Permalink to this headline">¶</a></h3>
<p>The &#8220;xapian-check&#8221; tool is capable of fixing corrupted databases in certain
limited situations.  Currently it only supports this for chert, where it is
capable of:</p>
<blockquote>
<div><ul class="simple">
<li>Regenerating a damaged <code class="docutils literal"><span class="pre">iamchert</span></code> file (if you&#8217;ve lost yours completely
just create an invalid one, e.g. with <code class="docutils literal"><span class="pre">touch</span> <span class="pre">iamchert</span></code>).</li>
<li>Regenerating damaged or lost base files from the corresponding DB files.
This was developed for the scenario where the database is freshly compacted
but should work provided the last update was cleanly applied.  If the last
update wasn&#8217;t actually committed, then it is possible that it will try to
pick the root block for the partial update, which isn&#8217;t what you want.
If you are in this situation, come and talk to us - with a testcase we
should be able to make it handle this better.</li>
</ul>
</div></blockquote>
<p>To fix such issues, run xapian-check like so:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>xapian-check /path/to/database F
</pre></div>
</div>
</div>
<div class="section" id="converting-a-chert-database-to-a-glass-database">
<span id="upgrading-databases"></span><h3><a class="toc-backref" href="#id21">Converting a chert database to a glass database</a><a class="headerlink" href="#converting-a-chert-database-to-a-glass-database" title="Permalink to this headline">¶</a></h3>
<p>This can be done using the <code class="docutils literal"><span class="pre">copydatabase</span></code> example program included with Xapian.
This is a lot slower to run than <code class="docutils literal"><span class="pre">xapian-compact</span></code>, since it has to perform the
sorting of the term occurrence data from scratch, but should be faster than a
re-index from source data since it doesn&#8217;t need to perform the tokenisation
step.  It is also useful if you no longer have the source data available.</p>
<p>The following command will copy a database from &#8220;SOURCE&#8221; to &#8220;DESTINATION&#8221;,
creating the new database at &#8220;DESTINATION&#8221; as a chert database:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>copydatabase SOURCE DESTINATION
</pre></div>
</div>
<p>By default copydatabase will renumber your documents starting with docid 1.
If the docids are stored in or come from some external system, you should
preserve them by using the <code class="docutils literal"><span class="pre">--no-renumber</span></code> option:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>copydatabase --no-renumber SOURCE DESTINATION
</pre></div>
</div>
</div>
<div class="section" id="converting-a-pre-1-1-4-chert-database-to-a-chert-database">
<h3><a class="toc-backref" href="#id22">Converting a pre-1.1.4 chert database to a chert database</a><a class="headerlink" href="#converting-a-pre-1-1-4-chert-database-to-a-chert-database" title="Permalink to this headline">¶</a></h3>
<p>The chert format changed in 1.1.4 - at that point the format hadn&#8217;t been
finalised, but a number of users had already deployed it, and it wasn&#8217;t hard
to write an updater, so we provided one called <cite>xapian-chert-update</cite> which
makes a copy with the updated format:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>xapian-chert-update SOURCE DESTINATION
</pre></div>
</div>
<p>It works much like <code class="docutils literal"><span class="pre">xapian-compact</span></code> so should take a similar amount of time
(and results in a compact database).  The initial version had a few bugs, so
use xapian-chert-update from Xapian 1.2.5 or later.</p>
<p>The <code class="docutils literal"><span class="pre">xapian-chert-update</span></code> utility was removed in Xapian 1.3.0, so you&#8217;ll need
to install Xapian 1.2.x to use it.</p>
</div>
<div class="section" id="converting-a-flint-database-to-a-chert-database">
<h3><a class="toc-backref" href="#id23">Converting a flint database to a chert database</a><a class="headerlink" href="#converting-a-flint-database-to-a-chert-database" title="Permalink to this headline">¶</a></h3>
<p>It is possible to convert a flint database to a chert database by installing
Xapian 1.2.x (since this has support for both flint and chert)
using the <code class="docutils literal"><span class="pre">copydatabase</span></code> example program included with Xapian.  This is a
lot slower to run than <code class="docutils literal"><span class="pre">xapian-compact</span></code>, since it has to perform the
sorting of the term occurrence data from scratch, but should be faster than a
re-index from source data since it doesn&#8217;t need to perform the tokenisation
step.  It is also useful if you no longer have the source data available.</p>
<p>The following command will copy a database from &#8220;SOURCE&#8221; to &#8220;DESTINATION&#8221;,
creating the new database at &#8220;DESTINATION&#8221; as a chert database:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">copydatabase</span> <span class="n">SOURCE</span> <span class="n">DESTINATION</span>
</pre></div>
</div>
<p>By default <code class="docutils literal"><span class="pre">copydatabase</span></code> will renumber your documents starting with docid 1.
If the docids are stored in or come from some external system, you should
preserve them by using the <code class="docutils literal"><span class="pre">--no-renumber</span></code> option (new in Xapian 1.2.5):</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">copydatabase</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">renumber</span> <span class="n">SOURCE</span> <span class="n">DESTINATION</span>
</pre></div>
</div>
</div>
<div class="section" id="converting-a-quartz-database-to-a-flint-database">
<h3><a class="toc-backref" href="#id24">Converting a quartz database to a flint database</a><a class="headerlink" href="#converting-a-quartz-database-to-a-flint-database" title="Permalink to this headline">¶</a></h3>
<p>It is possible to convert a quartz database to a flint database by installing
Xapian 1.0.x (since this has support for both quartz and flint)
and using the <code class="docutils literal"><span class="pre">copydatabase</span></code> example program included with Xapian.  This is a
lot slower to run than <code class="docutils literal"><span class="pre">xapian-compact</span></code>, since it has to perform the
sorting of the term occurrence data from scratch, but should be faster than a
re-index from source data since it doesn&#8217;t need to perform the tokenisation
step.  It is also useful if you no longer have the source data available.</p>
<p>The following command will copy a database from &#8220;SOURCE&#8221; to &#8220;DESTINATION&#8221;,
creating the new database at &#8220;DESTINATION&#8221; as a flint database:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">copydatabase</span> <span class="n">SOURCE</span> <span class="n">DESTINATION</span>
</pre></div>
</div>
</div>
<div class="section" id="converting-a-0-9-x-flint-database-to-work-with-1-0-y">
<h3><a class="toc-backref" href="#id25">Converting a 0.9.x flint database to work with 1.0.y</a><a class="headerlink" href="#converting-a-0-9-x-flint-database-to-work-with-1-0-y" title="Permalink to this headline">¶</a></h3>
<p>In 0.9.x, flint was the development backend.</p>
<p>Due to a bug in the flint position list encoding in 0.9.x which made flint
databases non-portable between platforms, we had to make an incompatible
change in the flint format.  It&#8217;s not easy to write an upgrader, but you
can convert a database using the following procedure (although it might
be better to rebuild from scratch if you want to use the new UTF-8 support
in <code class="docutils literal"><span class="pre">Xapian::QueryParser</span></code>, <code class="docutils literal"><span class="pre">Xapian::Stem</span></code>, and
<code class="docutils literal"><span class="pre">Xapian::TermGenerator</span></code>).</p>
<p>Run the following command in your Xapian 0.9.x installation to copy your
0.9.x flint database &#8220;SOURCE&#8221; to a new quartz database &#8220;INTERMEDIATE&#8221;:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">copydatabase</span> <span class="n">SOURCE</span> <span class="n">INTERMEDIATE</span>
</pre></div>
</div>
<p>Then run the following command in your Xapian 1.0.y installation to copy
your quartz database to a 1.0.y flint database &#8220;DESTINATION&#8221;:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">copydatabase</span> <span class="n">INTERMEDIATE</span> <span class="n">DESTINATION</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Xapian Administrator&#8217;s Guide</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#databases">Databases</a><ul>
<li><a class="reference internal" href="#glass-backend">Glass Backend</a></li>
<li><a class="reference internal" href="#chert-backend">Chert Backend</a></li>
<li><a class="reference internal" href="#atomic-modifications">Atomic modifications</a></li>
<li><a class="reference internal" href="#single-writer-multiple-reader">Single writer, multiple reader</a></li>
<li><a class="reference internal" href="#revision-numbers">Revision numbers</a></li>
<li><a class="reference internal" href="#network-file-systems">Network file systems</a></li>
<li><a class="reference internal" href="#which-database-format-to-use">Which database format to use?</a></li>
<li><a class="reference internal" href="#can-i-put-other-files-in-the-database-directory">Can I put other files in the database directory?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-strategies">Backup Strategies</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#detail">Detail</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inspecting-a-database">Inspecting a database</a></li>
<li><a class="reference internal" href="#database-maintenance">Database maintenance</a><ul>
<li><a class="reference internal" href="#compacting-a-database">Compacting a database</a></li>
<li><a class="reference internal" href="#merging-databases">Merging databases</a></li>
<li><a class="reference internal" href="#checking-database-integrity">Checking database integrity</a></li>
<li><a class="reference internal" href="#fixing-corrupted-databases">Fixing corrupted databases</a></li>
<li><a class="reference internal" href="#converting-a-chert-database-to-a-glass-database">Converting a chert database to a glass database</a></li>
<li><a class="reference internal" href="#converting-a-pre-1-1-4-chert-database-to-a-chert-database">Converting a pre-1.1.4 chert database to a chert database</a></li>
<li><a class="reference internal" href="#converting-a-flint-database-to-a-chert-database">Converting a flint database to a chert database</a></li>
<li><a class="reference internal" href="#converting-a-quartz-database-to-a-flint-database">Converting a quartz database to a flint database</a></li>
<li><a class="reference internal" href="#converting-a-0-9-x-flint-database-to-work-with-1-0-y">Converting a 0.9.x flint database to work with 1.0.y</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="custom_weighting.html"
                        title="previous chapter">Custom Weighting Schemes</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="scalability.html"
                        title="next chapter">Scalability</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/advanced/admin_notes.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="scalability.html" title="Scalability"
             >next</a> |</li>
        <li class="right" >
          <a href="custom_weighting.html" title="Custom Weighting Schemes"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Getting Started with Xapian v1.4</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Advanced features</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2003-2016 Xapian Documentation Team &amp; Contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.9.
    </div>
  </body>
</html>